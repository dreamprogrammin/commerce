-- =====================================================================================
-- üßπ –ú–ò–ì–†–ê–¶–ò–Ø –û–ß–ò–°–¢–ö–ò (ROLLBACK)
-- –£–¥–∞–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ –∏–∑ —Å—Ç–∞—Ä—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
-- =====================================================================================

-- 1. –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã (—Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ñ—É–Ω–∫—Ü–∏–π)
-- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ orders
DROP TRIGGER IF EXISTS trigger_notify_user_order ON public.orders;

-- –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ guest_checkouts (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
-- –ò—Å–ø–æ–ª—å–∑—É–µ–º DO –±–ª–æ–∫, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã guest_checkouts —É–∂–µ –Ω–µ—Ç
DO $$
BEGIN
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'guest_checkouts') THEN
        DROP TRIGGER IF EXISTS trigger_notify_guest_checkout ON public.guest_checkouts;
    END IF;
END $$;


-- 2. –£–¥–∞–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
DROP FUNCTION IF EXISTS public.notify_order_to_telegram();


-- 3. –£–¥–∞–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ (–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –û—Ç–º–µ–Ω–∞)
-- –£–¥–∞–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
DROP FUNCTION IF EXISTS public.confirm_user_order(UUID);
DROP FUNCTION IF EXISTS public.cancel_user_order(UUID);

-- –£–¥–∞–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π
DROP FUNCTION IF EXISTS public.confirm_guest_checkout(UUID);
DROP FUNCTION IF EXISTS public.cancel_guest_checkout(UUID);


-- 4. –£–¥–∞–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É URL –∏–∑ —Ç–∞–±–ª–∏—Ü—ã settings
DELETE FROM public.settings 
WHERE key = 'telegram_function_url';

-- =====================================================================================
-- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
-- –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞–∫–∞—Ç—ã–≤–∞—Ç—å –Ω–æ–≤—É—é –µ–¥–∏–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é.
-- =====================================================================================