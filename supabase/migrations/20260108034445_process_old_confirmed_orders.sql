-- =====================================================================================
-- –û–ë–†–ê–ë–û–¢–ö–ê –°–¢–ê–†–´–• –ü–û–î–¢–í–ï–†–ñ–î–Å–ù–ù–´–• –ó–ê–ö–ê–ó–û–í
-- =====================================================================================
-- –ü—Ä–æ–±–ª–µ–º–∞:
-- - –ó–∞–∫–∞–∑—ã –±—ã–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –î–û —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
-- - –£ –Ω–∏—Ö —Å—Ç–∞—Ç—É—Å = 'confirmed', –Ω–æ —Ç–æ–≤–∞—Ä—ã –ù–ï –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Å–æ —Å–∫–ª–∞–¥–∞
-- - processed_at = NULL –¥–ª—è guest_checkouts
-- - bonuses_activation_date = NULL –¥–ª—è orders
--
-- –†–µ—à–µ–Ω–∏–µ:
-- - –í—Ä—É—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
-- - –í—ã–∑–≤–∞—Ç—å –¥–ª—è –Ω–∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏ process_confirmed_order() –∏ process_confirmed_guest_checkout()
-- - –§—É–Ω–∫—Ü–∏–∏ —É–∂–µ –∏–º–µ—é—Ç –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
-- =====================================================================================

DO $$
DECLARE
  v_order_record RECORD;
  v_checkout_record RECORD;
  v_result TEXT;
  v_orders_processed INTEGER := 0;
  v_checkouts_processed INTEGER := 0;
BEGIN
  RAISE NOTICE 'üîÑ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤...';

  -- =====================================================================================
  -- –®–∞–≥ 1: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã orders
  -- =====================================================================================
  RAISE NOTICE 'üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã orders...';

  FOR v_order_record IN
    SELECT id, user_id, created_at
    FROM public.orders
    WHERE status = 'confirmed'
      AND bonuses_activation_date IS NULL  -- –ï—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
    ORDER BY created_at ASC
  LOOP
    BEGIN
      -- –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞
      SELECT public.process_confirmed_order(v_order_record.id) INTO v_result;

      v_orders_processed := v_orders_processed + 1;
      RAISE NOTICE '‚úÖ –ó–∞–∫–∞–∑ %: %', v_order_record.id, v_result;

    EXCEPTION WHEN OTHERS THEN
      -- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
      RAISE WARNING '‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–∫–∞–∑ %: %', v_order_record.id, SQLERRM;
    END;
  END LOOP;

  -- =====================================================================================
  -- –®–∞–≥ 2: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥–æ—Å—Ç–µ–≤—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã guest_checkouts
  -- =====================================================================================
  RAISE NOTICE 'üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã guest_checkouts...';

  FOR v_checkout_record IN
    SELECT id, guest_email, created_at
    FROM public.guest_checkouts
    WHERE status = 'confirmed'
      AND processed_at IS NULL  -- –ï—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
    ORDER BY created_at ASC
  LOOP
    BEGIN
      -- –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
      SELECT public.process_confirmed_guest_checkout(v_checkout_record.id) INTO v_result;

      v_checkouts_processed := v_checkouts_processed + 1;
      RAISE NOTICE '‚úÖ –ì–æ—Å—Ç–µ–≤–æ–π –∑–∞–∫–∞–∑ %: %', v_checkout_record.id, v_result;

    EXCEPTION WHEN OTHERS THEN
      -- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ, –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
      RAISE WARNING '‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–æ—Å—Ç–µ–≤–æ–π –∑–∞–∫–∞–∑ %: %', v_checkout_record.id, SQLERRM;
    END;
  END LOOP;

  -- =====================================================================================
  -- –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
  -- =====================================================================================
  RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';
  RAISE NOTICE '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
  RAISE NOTICE '   - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤ (orders): %', v_orders_processed;
  RAISE NOTICE '   - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (guest_checkouts): %', v_checkouts_processed;
  RAISE NOTICE '   - –ò–¢–û–ì–û –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: %', v_orders_processed + v_checkouts_processed;
  RAISE NOTICE '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';

END $$;

-- =====================================================================================
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
-- =====================================================================================
-- –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –∑–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã:
--
-- SELECT
--   'orders' as table_name,
--   COUNT(*) as total_confirmed,
--   COUNT(*) FILTER (WHERE bonuses_activation_date IS NOT NULL) as processed,
--   COUNT(*) FILTER (WHERE bonuses_activation_date IS NULL) as not_processed
-- FROM orders
-- WHERE status = 'confirmed'
-- UNION ALL
-- SELECT
--   'guest_checkouts',
--   COUNT(*),
--   COUNT(*) FILTER (WHERE processed_at IS NOT NULL),
--   COUNT(*) FILTER (WHERE processed_at IS NULL)
-- FROM guest_checkouts
-- WHERE status = 'confirmed';
-- =====================================================================================
