<script setup lang="ts">
import { storeToRefs } from 'pinia'
import { useProfileStore } from '@/stores/core/profileStore'
import { useModalStore } from '@/stores/modal/useModalStore'

const profileStore = useProfileStore()
const modalStore = useModalStore()

const { profile, isLoading, bonusBalance, isLoggedIn } = storeToRefs(profileStore)

onMounted(() => {
  if (isLoggedIn.value && !profile.value) {
    profileStore.loadProfile()
  }
})
</script>

<template>
  <Card class="relative overflow-hidden border-2 border-blue-200 dark:border-blue-800 hover:shadow-lg transition-all duration-300 bg-gradient-to-br from-blue-50/50 via-purple-50/30 to-pink-50/50 dark:from-blue-950/20 dark:via-purple-950/20 dark:to-pink-950/20">
    <!-- –ú—è–≥–∫–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <div class="absolute top-0 right-0 w-40 h-40 bg-blue-200/30 dark:bg-blue-800/20 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl" />
    <div class="absolute bottom-0 left-0 w-32 h-32 bg-pink-200/30 dark:bg-pink-800/20 rounded-full translate-y-1/2 -translate-x-1/2 blur-3xl" />

    <!-- –ú–∞–ª–µ–Ω—å–∫–∏–µ –∑–≤—ë–∑–¥–æ—á–∫–∏ –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è -->
    <div class="absolute top-6 right-12">
      <Icon name="lucide:sparkle" class="w-4 h-4 text-yellow-400/60" />
    </div>
    <div class="absolute bottom-20 right-8">
      <Icon name="lucide:star" class="w-3 h-3 text-blue-400/60" />
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="relative">
      <CardHeader class="space-y-3 pb-4">
        <!-- –ò–∫–æ–Ω–∫–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 p-2.5 bg-gradient-to-br from-blue-300 to-purple-300 rounded-2xl shadow-sm">
            <Icon name="lucide:gift" class="w-5 h-5 text-white" />
          </div>
          <div class="flex-1">
            <CardTitle class="text-lg font-bold text-gray-800 dark:text-gray-100">
              –ö–æ–ø–∏–ª–∫–∞ –±–æ–Ω—É—Å–æ–≤ üéÅ
            </CardTitle>
            <CardDescription class="mt-0.5 text-sm">
              –ü–æ–ª—É—á–∞–π –ø–æ–¥–∞—Ä–∫–∏ –∑–∞ –ø–æ–∫—É–ø–∫–∏
            </CardDescription>
          </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ -->
        <div class="p-3 bg-white/80 dark:bg-gray-900/50 backdrop-blur-sm rounded-xl border-2 border-blue-100 dark:border-blue-900/50">
          <div class="flex items-center gap-2.5">
            <div class="w-9 h-9 bg-gradient-to-br from-yellow-200 to-orange-200 dark:from-yellow-900/40 dark:to-orange-900/40 rounded-full flex items-center justify-center flex-shrink-0">
              <Icon name="lucide:coins" class="w-5 h-5 text-orange-600 dark:text-orange-400" />
            </div>
            <div>
              <p class="text-xs text-muted-foreground font-medium">
                –ü—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ
              </p>
              <p class="text-lg font-bold text-blue-600 dark:text-blue-400">
                1 –±–æ–Ω—É—Å = 1 ‚Ç∏
              </p>
            </div>
          </div>
        </div>
      </CardHeader>

      <CardContent class="space-y-3 pb-4">
        <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å –º—è–≥–∫–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏ -->
        <div class="space-y-2">
          <div class="flex items-center gap-2.5 p-2 bg-white/60 dark:bg-gray-900/40 rounded-lg hover:bg-white/80 dark:hover:bg-gray-900/60 transition-colors">
            <div class="w-6 h-6 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center flex-shrink-0">
              <Icon name="lucide:heart" class="w-4 h-4 text-green-600 dark:text-green-400" />
            </div>
            <p class="text-xs font-medium text-gray-700 dark:text-gray-300">
              –ö—ç—à–±–µ–∫ —Å –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–∏ ‚ú®
            </p>
          </div>
          <div class="flex items-center gap-2.5 p-2 bg-white/60 dark:bg-gray-900/40 rounded-lg hover:bg-white/80 dark:hover:bg-gray-900/60 transition-colors">
            <div class="w-6 h-6 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center flex-shrink-0">
              <Icon name="lucide:smile" class="w-4 h-4 text-blue-600 dark:text-blue-400" />
            </div>
            <p class="text-xs font-medium text-gray-700 dark:text-gray-300">
              –û–ø–ª–∞—Ç–∞ –¥–æ 100% –±–æ–Ω—É—Å–∞–º–∏ üéà
            </p>
          </div>
          <div class="flex items-center gap-2.5 p-2 bg-white/60 dark:bg-gray-900/40 rounded-lg hover:bg-white/80 dark:hover:bg-gray-900/60 transition-colors">
            <div class="w-6 h-6 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center flex-shrink-0">
              <Icon name="lucide:star" class="w-4 h-4 text-purple-600 dark:text-purple-400" />
            </div>
            <p class="text-xs font-medium text-gray-700 dark:text-gray-300">
              –ë–æ–Ω—É—Å—ã –Ω–µ —Å–≥–æ—Ä–∞—é—Ç üåü
            </p>
          </div>
        </div>

        <!-- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <ClientOnly>
          <div v-if="isLoggedIn" class="mt-4">
            <div v-if="isLoading" class="h-20 flex items-center justify-center">
              <Icon name="lucide:loader-2" class="w-6 h-6 animate-spin text-blue-400" />
            </div>
            <div v-else-if="profile" class="p-4 bg-gradient-to-br from-blue-400 to-purple-400 rounded-2xl shadow-md">
              <p class="text-xs font-semibold text-white/80 mb-1">
                –í–∞—à–∞ –∫–æ–ø–∏–ª–∫–∞
              </p>
              <div class="flex items-baseline gap-2">
                <p class="text-3xl font-bold text-white">
                  {{ bonusBalance }}
                </p>
                <span class="text-sm text-white/90 font-medium">–±–æ–Ω—É—Å–æ–≤</span>
              </div>
            </div>
          </div>

          <template #fallback>
            <div class="mt-4 p-4 bg-white/80 dark:bg-gray-900/60 backdrop-blur-sm rounded-2xl border-2 border-dashed border-blue-200 dark:border-blue-800">
              <div class="text-center">
                <Icon name="lucide:gift" class="w-6 h-6 text-blue-300 dark:text-blue-600 mx-auto mb-1" />
                <p class="text-xs font-medium text-gray-600 dark:text-gray-400">
                  –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–æ–ø–∏—Ç—å! üéâ
                </p>
              </div>
            </div>
          </template>
        </ClientOnly>
      </CardContent>

      <CardFooter class="flex-col gap-2 pt-3 border-t border-blue-100 dark:border-blue-900">
        <ClientOnly>
          <!-- –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
          <div v-if="isLoggedIn" class="w-full space-y-2">
            <NuxtLink to="/profile/bonuses" class="block">
              <Button size="default" class="w-full bg-gradient-to-r from-blue-400 to-purple-400 hover:from-blue-500 hover:to-purple-500 text-white font-semibold shadow-sm hover:shadow-md transition-all rounded-xl text-sm">
                <Icon name="lucide:history" class="w-4 h-4 mr-2" />
                –ò—Å—Ç–æ—Ä–∏—è –±–æ–Ω—É—Å–æ–≤
              </Button>
            </NuxtLink>
            <NuxtLink to="/bonus-program-rules">
              <Button variant="ghost" size="sm" class="w-full text-muted-foreground hover:text-foreground text-xs rounded-lg">
                –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                <Icon name="lucide:arrow-right" class="w-3 h-3 ml-2" />
              </Button>
            </NuxtLink>
          </div>

          <!-- –î–ª—è –≥–æ—Å—Ç–µ–π -->
          <div v-else class="w-full space-y-2">
            <Button
              size="default"
              class="w-full bg-gradient-to-r from-blue-400 to-purple-400 hover:from-blue-500 hover:to-purple-500 text-white font-semibold shadow-sm hover:shadow-md transition-all rounded-xl text-sm"
              @click="modalStore.openLoginModal()"
            >
              <Icon name="lucide:log-in" class="w-4 h-4 mr-2" />
              –í–æ–π—Ç–∏ –∏ –Ω–∞—á–∞—Ç—å –∫–æ–ø–∏—Ç—å
            </Button>
            <NuxtLink to="/bonus-program-rules">
              <Button variant="ghost" size="sm" class="w-full text-muted-foreground hover:text-foreground text-xs rounded-lg">
                –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞?
                <Icon name="lucide:arrow-right" class="w-3 h-3 ml-2" />
              </Button>
            </NuxtLink>
          </div>

          <!-- Fallback –¥–ª—è SSR -->
          <template #fallback>
            <div class="w-full space-y-2">
              <NuxtLink to="/profile">
                <Button size="default" class="w-full bg-gradient-to-r from-blue-400 to-purple-400 hover:from-blue-500 hover:to-purple-500 text-white font-semibold shadow-sm rounded-xl text-sm">
                  <Icon name="lucide:log-in" class="w-4 h-4 mr-2" />
                  –í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </Button>
              </NuxtLink>
              <NuxtLink to="/bonus-program-rules">
                <Button variant="ghost" size="sm" class="w-full text-muted-foreground hover:text-foreground text-xs rounded-lg">
                  –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                  <Icon name="lucide:arrow-right" class="w-3 h-3 ml-2" />
                </Button>
              </NuxtLink>
            </div>
          </template>
        </ClientOnly>
      </CardFooter>
    </div>
  </Card>
</template>
