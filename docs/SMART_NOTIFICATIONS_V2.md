# –£–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è v2

–î–∞—Ç–∞: 2026-02-25

## –û–±–∑–æ—Ä

–ü—è—Ç—å –Ω–æ–≤—ã—Ö —Ñ–∏—á —É–º–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞–π–ø–ª–∞–π–Ω:
`INSERT –≤ notifications` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä `trigger_telegram_on_notification` ‚Üí edge function `send-user-telegram` (—Å magic link –∫–Ω–æ–ø–∫–∞–º–∏).

---

## 1. Cross-sell + –°–≥–æ—Ä–∞—é—â–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –≤ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–∏ **24-—á–∞—Å–æ–≤–æ–º** –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –æ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω–µ (—Ñ—É–Ω–∫—Ü–∏—è `check_abandoned_carts()`):

1. –°–æ–±–∏—Ä–∞—é—Ç—Å—è –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã —á–µ—Ä–µ–∑ `products.accessory_ids`
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∞ `TG5-XXXXX` (5 hex —Å–∏–º–≤–æ–ª–æ–≤)
3. –ü—Ä–æ–º–æ–∫–æ–¥: **5% —Å–∫–∏–¥–∫–∞, –¥–µ–π—Å—Ç–≤—É–µ—Ç 2 —á–∞—Å–∞**, –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram:**
```
üî• –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –∫–æ—Ä–∑–∏–Ω—É!
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä LEGO City –∂–¥—ë—Ç –≤–∞—Å! –°—É–º–º–∞: 15 000 ‚Ç∏
–ù–µ –∑–∞–±—É–¥—å—Ç–µ: –ë–∞—Ç–∞—Ä–µ–π–∫–∏ AA, –ü–æ–¥–∞—Ä–æ—á–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞.
üéÅ –í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥: TG5-A3F2B (—Å–∫–∏–¥–∫–∞ 5%, –¥–µ–π—Å—Ç–≤—É–µ—Ç 2 —á–∞—Å–∞)
```

1-—á–∞—Å–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ —Ä–∞–Ω—å—à–µ, —Å —Ñ–æ—Ç–æ –∏ magic link).

### –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ checkout

–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ ¬´–ü—Ä–æ–º–æ–∫–æ–¥¬ª:
- –ü–æ–ª–µ –≤–≤–æ–¥–∞ + –∫–Ω–æ–ø–∫–∞ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ RPC `validate_promo_code(code, order_amount)` ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫, –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π, –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É, –ø—Ä–∏–≤—è–∑–∫—É –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–µ–ª—ë–Ω—ã–π –±–ª–æ–∫ —Å –∫–æ–¥–æ–º –∏ —Å—É–º–º–æ–π —Å–∫–∏–¥–∫–∏
- –°–∫–∏–¥–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ sidebar –∑–∞–∫–∞–∑–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
- –ü—Ä–æ–º–æ–∫–æ–¥ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `create_user_order` / `create_guest_checkout` —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `p_promo_code`

### –¢–∞–±–ª–∏—Ü–∞ `promo_codes`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID | PK |
| code | TEXT UNIQUE | –ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UPPER) |
| user_id | UUID NULL | NULL = —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π, –∏–Ω–∞—á–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |
| discount_percent | NUMERIC | –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (1-100) |
| min_order_amount | NUMERIC | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0) |
| max_uses | INTEGER | –ú–∞–∫—Å. —á–∏—Å–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1) |
| uses_count | INTEGER | –¢–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π |
| expires_at | TIMESTAMPTZ | –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
| used_at | TIMESTAMPTZ | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |

**Cron**: –∫–∞–∂–¥—ã–π —á–∞—Å —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–æ–º–æ–∫–æ–¥—ã, –∏—Å—Ç—ë–∫—à–∏–µ –±–æ–ª–µ–µ 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥.

### –§–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ |
|------|-------------|
| `supabase/migrations/20260225000000_promo_codes.sql` | –¢–∞–±–ª–∏—Ü–∞, RLS, validate_promo_code(), cron |
| `supabase/migrations/20260225000001_order_functions_promo.sql` | create_user_order + create_guest_checkout —Å p_promo_code |
| `supabase/migrations/20260225000002_cart_crosssell_promo.sql` | check_abandoned_carts() —Å cross-sell + –ø—Ä–æ–º–æ–∫–æ–¥ |
| `stores/publicStore/promoCodeStore.ts` | Pinia store: validateCode(), clearCode() |
| `pages/checkout.vue` | UI –±–ª–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–∞, —Å–∫–∏–¥–∫–∞ –≤ sidebar |
| `stores/publicStore/cartStore.ts` | p_promo_code –≤ RPC –≤—ã–∑–æ–≤–∞—Ö |
| `types/type.ts` | promoCode –≤ ICheckoutData |

---

## 2. Wishlist-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–¢—Ä–∏–≥–≥–µ—Ä `notify_wishlist_on_product_change()` –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ `products` (AFTER UPDATE OF price, discount_percentage, stock_quantity):

**–°–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã:**
- –ï—Å–ª–∏ `new_final_price < old_final_price`
- –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —ç—Ç–∏–º —Ç–æ–≤–∞—Ä–æ–º –≤ wishlist
- –¢–∏–ø: `price_drop`

```
üìâ –¶–µ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∞!
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä LEGO City —Ç–µ–ø–µ—Ä—å 12 000 ‚Ç∏ (–±—ã–ª–æ 15 000 ‚Ç∏)
```

**–ú–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ:**
- –ï—Å–ª–∏ `old_stock > 3 AND new_stock <= 3 AND new_stock > 0`
- –¢–∏–ø: `low_stock`

```
‚ö†Ô∏è –¢–æ–≤–∞—Ä –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è!
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä LEGO City ‚Äî –æ—Å—Ç–∞–ª–æ—Å—å 2 —à—Ç. –£—Å–ø–µ–π—Ç–µ –∫—É–ø–∏—Ç—å!
```

Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å magic link –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç—Ä–∏–≥–≥–µ—Ä `trigger_telegram_on_notification`.

### –§–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ |
|------|-------------|
| `supabase/migrations/20260225010000_wishlist_notifications.sql` | –¢—Ä–∏–≥–≥–µ—Ä notify_wishlist_on_product_change() |

Frontend-–∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞–π–ø–ª–∞–π–Ω.

---

## 3. Back in Stock

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–≤–∞—Ä —Å `stock_quantity = 0`
2. –í–º–µ—Å—Ç–æ disabled –∫–Ω–æ–ø–∫–∏ ¬´–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ **¬´–°–æ–æ–±—â–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏¬ª**
3. –ü—Ä–∏ –∫–ª–∏–∫–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `toggle_stock_alert(product_id)` ‚Äî —Å–æ–∑–¥–∞—ë—Ç/—É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ `stock_alerts`
4. –ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω –ø–æ–ø–æ–ª–Ω—è–µ—Ç —Å–∫–ª–∞–¥ (`stock_quantity: 0 ‚Üí N`), —Ç—Ä–∏–≥–≥–µ—Ä `notify_back_in_stock()`:
   - –°–æ–∑–¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –ø–æ–¥–ø–∏—Å—á–∏–∫—É
   - –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)

```
üéâ –¢–æ–≤–∞—Ä —Å–Ω–æ–≤–∞ –≤ –Ω–∞–ª–∏—á–∏–∏!
–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä LEGO City —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞!
```

### –¢–∞–±–ª–∏—Ü–∞ `stock_alerts`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| user_id | UUID | FK ‚Üí profiles (—á–∞—Å—Ç—å composite PK) |
| product_id | UUID | FK ‚Üí products (—á–∞—Å—Ç—å composite PK) |
| created_at | TIMESTAMPTZ | –î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ |

### –§–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ |
|------|-------------|
| `supabase/migrations/20260225020000_back_in_stock.sql` | –¢–∞–±–ª–∏—Ü–∞, RLS, toggle_stock_alert(), —Ç—Ä–∏–≥–≥–µ—Ä |
| `stores/publicStore/stockAlertsStore.ts` | Pinia store: fetchSubscriptions(), toggleAlert(), isSubscribed |
| `components/product/StockAlertButton.vue` | –ö–Ω–æ–ø–∫–∞ —Å toggle-—Å–æ—Å—Ç–æ—è–Ω–∏–µ–º |
| `pages/catalog/products/[slug].vue` | –ó–∞–º–µ–Ω–∞ disabled –∫–Ω–æ–ø–∫–∏ –Ω–∞ StockAlertButton |

---

## 4. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±—ë–Ω–∫–∞

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

Cron `check_birthday_notifications()` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 09:00 UTC**:

1. –ò—â–µ—Ç –¥–µ—Ç–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `children` —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –±—ã–ª–æ –ª–∏ `birthday_reminder` –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º –≥–æ–¥—É
3. –ü–æ–¥–±–∏—Ä–∞–µ—Ç 3 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (`min_age_years/max_age_years`) –∏ –ø–æ–ª—É —Ä–µ–±—ë–Ω–∫–∞
4. –ù–∞—á–∏—Å–ª—è–µ—Ç **1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤** (—Å—Ä–∞–∑—É –¥–æ—Å—Ç—É–ø–Ω—ã, –±–µ–∑ pending)
5. –°–æ–∑–¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ–¥–∞—Ä–∫–æ–≤

```
üéÇ –°–∫–æ—Ä–æ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è!
–ß–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ê—Ä—Ç—ë–º—É –∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è 5 –ª–µ—Ç!
–ò–¥–µ–∏ –ø–æ–¥–∞—Ä–∫–æ–≤: –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä LEGO, –†–æ–±–æ—Ç-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä, –ù–∞–±–æ—Ä –∫—Ä–∞—Å–æ–∫.
üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 1000 –±–æ–Ω—É—Å–æ–≤!
```

### –ë–æ–Ω—É—Å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

- `transaction_type = 'birthday'`
- `status = 'completed'`
- `amount = 1000`
- –û–ø–∏—Å–∞–Ω–∏–µ: ¬´–ë–æ–Ω—É—Å—ã –∫–æ –¥–Ω—é —Ä–æ–∂–¥–µ–Ω–∏—è {–∏–º—è} ({N} –ª–µ—Ç)¬ª

### –§–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ |
|------|-------------|
| `supabase/migrations/20260225030000_birthday_notifications.sql` | check_birthday_notifications(), cron, constraint update |
| `pages/profile/bonuses/index.vue` | birthday –≤ display maps (–∏–∫–æ–Ω–∫–∞ Cake, –∑–µ–ª—ë–Ω—ã–π —Ü–≤–µ—Ç) |

---

## 5. –°–≥–æ—Ä–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞:** `bonus_transactions.expires_at` ‚Äî –¥–∞—Ç–∞ —Å–≥–æ—Ä–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤.

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:**
1. –ë–æ–Ω—É—Å—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è (`activation`, `welcome`, `review`, `birthday`) ‚Üí `expires_at = now() + 90 days`
2. –ó–∞ 3 –¥–Ω—è –¥–æ —Å–≥–æ—Ä–∞–Ω–∏—è: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `check_expiring_bonuses()` (cron 08:00 UTC)
3. –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è: —Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `expire_bonuses()` (cron 02:00 UTC)

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–∑–∞ 3 –¥–Ω—è):**
```
‚è≥ –ë–æ–Ω—É—Å—ã —Å–∫–æ—Ä–æ —Å–≥–æ—Ä—è—Ç!
–£ –≤–∞—Å 500 –±–æ–Ω—É—Å–æ–≤ —Å–≥–æ—Ä–∏—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö!
```

**–°–≥–æ—Ä–∞–Ω–∏–µ:**
```
üíî –ë–æ–Ω—É—Å—ã —Å–≥–æ—Ä–µ–ª–∏
500 –±–æ–Ω—É—Å–æ–≤ —Å–≥–æ—Ä–µ–ª–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–æ–Ω—É—Å—ã –≤–æ–≤—Ä–µ–º—è!
```

### –ü—Ä–æ—Ü–µ—Å—Å —Å–ø–∏—Å–∞–Ω–∏—è (`expire_bonuses()`)

1. –ù–∞—Ö–æ–¥–∏—Ç `bonus_transactions` –≥–¥–µ `expires_at < now()`, `status = 'completed'`, `amount > 0`
2. –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ `user_id`
3. –£–º–µ–Ω—å—à–∞–µ—Ç `profiles.active_bonus_balance` (–Ω–µ –Ω–∏–∂–µ 0)
4. –ü–æ–º–µ—á–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–∞–∫ `status = 'cancelled'`
5. –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é `type = 'expiration'` —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º amount
6. –°–æ–∑–¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ `bonus_expired`

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

`activate_pending_bonuses()` –∏ `activate_my_pending_bonuses()` —Ç–µ–ø–µ—Ä—å –ø—Ä–∏ INSERT activation-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ—Å—Ç–∞–≤–ª—è—é—Ç `expires_at = now() + 90 days`.

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ completed —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (activation/welcome/review/birthday) –ø–æ–ª—É—á–∏–ª–∏ `expires_at = created_at + 90 days` —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é.

### –§–∞–π–ª—ã

| –§–∞–π–ª | –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ |
|------|-------------|
| `supabase/migrations/20260225040000_bonus_expiration.sql` | expires_at, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, cron –∑–∞–¥–∞—á–∏ |
| `pages/profile/bonuses/index.vue` | expiration –≤ display maps (–∏–∫–æ–Ω–∫–∞ Timer, –∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç) |

---

## Constraint bonus_transactions_transaction_type_check

–§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ç–∏–ø–æ–≤:
```sql
'earned', 'spent', 'welcome', 'refund_spent', 'refund_earned',
'activation', 'review', 'birthday', 'expiration'
```

Constraint –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö:
- `20260225030000` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç `birthday`
- `20260225040000` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç `expiration` (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–º–æ–∫–æ–¥
1. –í—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å `SELECT check_abandoned_carts()` (–∏–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å 24—á)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –≤ Telegram
3. –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ checkout ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–∏–¥–∫—É
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ / –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è

### Cross-sell
1. –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É —Ç–æ–≤–∞—Ä —Å `accessory_ids`
2. –í—ã–∑–≤–∞—Ç—å `check_abandoned_carts()` –≤—Ä—É—á–Ω—É—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –≤ 24—á —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏

### Wishlist ‚Äî —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
2. –í –∞–¥–º–∏–Ω–∫–µ —Å–Ω–∏–∑–∏—Ç—å —Ü–µ–Ω—É –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å discount_percentage
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ `price_drop`

### Wishlist ‚Äî –º–∞–ª–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
1. –¢–æ–≤–∞—Ä –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º —Å stock > 3
2. –£–º–µ–Ω—å—à–∏—Ç—å stock –¥–æ 2
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ `low_stock`

### Back in Stock
1. –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä —Å stock = 0
2. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞–∂–∞—Ç—å ¬´–°–æ–æ–±—â–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏¬ª
3. –í –∞–¥–º–∏–Ω–∫–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å stock = 5
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ stock_alerts

### –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è
1. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞ —Å birth_date = current_date + 7 –¥–Ω–µ–π
2. –í—ã–∑–≤–∞—Ç—å `SELECT check_birthday_notifications()`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + 1000 –±–æ–Ω—É—Å–æ–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ

### –°–≥–æ—Ä–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
1. –í—Å—Ç–∞–≤–∏—Ç—å bonus_transaction —Å `expires_at = now() + interval '3 days 1 hour'`
2. –í—ã–∑–≤–∞—Ç—å `SELECT check_expiring_bonuses()` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
3. –û–±–Ω–æ–≤–∏—Ç—å `expires_at = now() - interval '1 hour'`
4. –í—ã–∑–≤–∞—Ç—å `SELECT expire_bonuses()` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
