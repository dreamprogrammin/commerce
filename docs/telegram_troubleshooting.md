# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Telegram ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹

## ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

### 1. ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ

```bash
pnpm supabase db push
```

Ð­Ñ‚Ð° Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ:

- âœ… Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ `pg_net` (Ð´Ð»Ñ HTTP Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²)
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¾Ð²
- âœ… Ð¡Ð¾Ð·Ð´Ð°ÑÑ‚ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
- âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ URL

### 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð² Supabase Dashboard

ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ: https://supabase.com/dashboard/project/gvsdevsvzgcivpphcuai/settings/functions

Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹:

```bash
TELEGRAM_BOT_TOKEN=Ð²Ð°Ñˆ_Ñ‚Ð¾ÐºÐµÐ½_Ð±Ð¾Ñ‚Ð°
TELEGRAM_CHAT_ID=Ð²Ð°Ñˆ_chat_id
ADMIN_SECRET=Ð²Ð°Ñˆ_ÑÐµÐºÑ€ÐµÑ‚ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
```

### 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð·Ð°ÐºÐ°Ð·

**Ð’Ð°Ð¶Ð½Ð¾!** Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ:

- `orders` - Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
- `guest_checkouts` - Ð³Ð¾ÑÑ‚ÐµÐ²Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹

Ð•ÑÐ»Ð¸ Ð²Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Ð´Ñ€ÑƒÐ³ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ð¸Ð»Ð¸ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ - Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚.

### 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Edge Function

ÐŸÐ¾ÑÐ»Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°:

1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ: https://supabase.com/dashboard/project/gvsdevsvzgcivpphcuai/functions/notify-order-to-telegram/invocations
2. ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
3. Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð² Ð½ÐµÑ‚ - Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð½Ðµ ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚
4. Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ ÐµÑÑ‚ÑŒ, Ð½Ð¾ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸ - ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð»Ð¾Ð³Ð¸

### 5. Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð°

Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð² SQL Editor:

```sql
-- Ð”Ð»Ñ Ð³Ð¾ÑÑ‚ÐµÐ²Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ guest_checkouts)
SELECT public.create_guest_checkout(
  '[{"product_id": "Ð²Ð°Ñˆ_product_id", "quantity": 1}]'::jsonb,
  '{"name": "Ð¢ÐµÑÑ‚", "email": "test@test.com", "phone": "+7123456789"}'::jsonb,
  'pickup'
);

-- Ð”Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ orders)
-- ÐÑƒÐ¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼
SELECT public.create_user_order(
  '[{"product_id": "Ð²Ð°Ñˆ_product_id", "quantity": 1}]'::jsonb,
  'pickup',
  'cash',
  NULL,
  0
);
```

### 6. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

Ð•ÑÐ»Ð¸ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:

```sql
-- ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ ID Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
SELECT id FROM public.orders ORDER BY created_at DESC LIMIT 1;
-- Ð¸Ð»Ð¸
SELECT id FROM public.guest_checkouts ORDER BY created_at DESC LIMIT 1;

-- Ð’Ñ‹Ð·Ð¾Ð²Ð¸Ñ‚Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
SELECT public.notify_order_to_telegram();
```

## ðŸ› Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 1: pg_net Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ `20251219060200_check_and_fix_telegram.sql` ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ ÐµÐ³Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 2: Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°ÑÑ‚ Ð¸Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 3: ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð² Supabase Dashboard â†’ Settings â†’ Edge Functions â†’ Secrets

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 4: Ð¡Ñ‚Ð°Ñ€Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ `orders` Ð¸Ð»Ð¸ `guest_checkouts`, Ð° Ð½Ðµ ÑÑ‚Ð°Ñ€ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° 5: RLS Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `SECURITY DEFINER`, Ð´Ð¾Ð»Ð¶Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ

## âœ… Ð§ÐµÐºÐ»Ð¸ÑÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸

- [ ] ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð° Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ `20251219060200_check_and_fix_telegram.sql`
- [ ] Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID)
- [ ] Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚ (Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð² SQL Editor)
- [ ] pg_net Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹ Ð»Ð¾Ð³Ð¸ Edge Function
- [ ] ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram

## ðŸ“ž Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð»Ð¾

Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð² SQL Editor Ð¸ Ð¿Ñ€Ð¸ÑˆÐ»Ð¸Ñ‚Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:

```sql
-- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
SELECT
  'Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹' as component,
  COUNT(*) as count,
  string_agg(trigger_name, ', ') as details
FROM information_schema.triggers
WHERE trigger_name IN ('trigger_notify_user_order', 'trigger_notify_guest_checkout')
UNION ALL
SELECT
  'Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ notify_order_to_telegram' as component,
  COUNT(*) as count,
  NULL as details
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name = 'notify_order_to_telegram'
UNION ALL
SELECT
  'Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ pg_net' as component,
  COUNT(*) as count,
  NULL as details
FROM pg_extension
WHERE extname = 'pg_net'
UNION ALL
SELECT
  'ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ URL' as component,
  COUNT(*) as count,
  value->>'url' as details
FROM public.settings
WHERE key = 'telegram_function_url';
```
