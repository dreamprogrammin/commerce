# Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐµÑˆÐµÐ¼ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸

## ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¼Ñ‹ Ñ€ÐµÑˆÐ¸Ð»Ð¸

ÐŸÑ€Ð¸ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð² Ð°Ð´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹) Ð½Ðµ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ð»Ð¸ÑÑŒ ÑÑ€Ð°Ð·Ñƒ Ð¸Ð·-Ð·Ð° ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ TanStack Query. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐ», Ð½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð±Ñ‹Ð»Ð¸ Ð²Ð¸Ð´Ð½Ñ‹.

## Ð ÐµÑˆÐµÐ½Ð¸Ðµ

### 1. Composable `useCacheManager`

Ð¡Ð¾Ð·Ð´Ð°Ð½ ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ composable Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐµÑˆÐµÐ¼:

```typescript
// Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ
const { clearProductCache, clearAllQueryCache, hardReset } = useCacheManager()

// ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐµÑˆ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
await clearProductCache(productId)

// ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÐµÑÑŒ ÐºÐµÑˆ
clearAllQueryCache()

// Ð–ÐµÑÑ‚ÐºÐ°Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° (Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° + reload)
hardReset()
```

### 2. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸

Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (`pages/admin/products/[id].vue`):

```typescript
async function handleUpdate(payload) {
  // ... ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°

  // ðŸ”¥ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐµÑˆ
  await clearProductCache(productId)
  adminProductsStore.products = []

  // ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
  await refresh()

  // âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¾ÑÑ‚Ð°ÐµÑ‚ÑÑ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ð¸ Ð²Ð¸Ð´Ð¸Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
}
```

**Ð’Ð°Ð¶Ð½Ð¾**: Ð£Ð±Ñ€Ð°Ð»Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° `/admin/products` Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ - Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ð¸Ð´Ð¸Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÑ€Ð°Ð·Ñƒ.

### 3. ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐµÑˆÐµÐ¼

#### Ð’ Ð°Ð´Ð¼Ð¸Ð½ layout (Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð²ÐµÐ·Ð´Ðµ):
- **ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐµÑˆ** - Ð¼ÑÐ³ÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° TanStack Query ÐºÐµÑˆÐ°
- **ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ ÑÐ±Ñ€Ð¾Ñ** - Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐµÑˆÐ° + localStorage + Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹

#### ÐÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:
- **ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ** - Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¸Ð· Ð‘Ð”
- **Ðš ÑÐ¿Ð¸ÑÐºÑƒ** - Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ðº ÑÐ¿Ð¸ÑÐºÑƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²

## Ð¢Ð¸Ð¿Ñ‹ ÐºÐµÑˆÐ° Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸

### 1. TanStack Query Cache (Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸)
- **Lifetime**: Ð”Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð²ÐºÐ»Ð°Ð´ÐºÐ¸
- **staleTime**: 5 Ð¼Ð¸Ð½ÑƒÑ‚
- **gcTime**: 10 Ð¼Ð¸Ð½ÑƒÑ‚
- **Persistence**: LocalStorage (`tanstack-query-cache`)

### 2. Nuxt useAsyncData Cache
- **Lifetime**: Ð”Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
- **Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ**: `refresh()` Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
- **ÐÐµ Ð¿ÐµÑ€ÑÐ¸ÑÑ‚Ð¸Ñ‚ÑÑ** Ð¼ÐµÐ¶Ð´Ñƒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°Ð¼Ð¸

### 3. Pinia Store Cache
- **Lifetime**: Ð”Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð²ÐºÐ»Ð°Ð´ÐºÐ¸
- **Persistence**: LocalStorage (Ñ‡ÐµÑ€ÐµÐ· `pinia-plugin-persistedstate`)
- **ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°**: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð² `[]` Ð¸Ð»Ð¸ `null`

## ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹

### 1. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¼ÐµÐ½ÑÐµÑ‚ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
```typescript
// ProductForm.vue
function setPrimaryExistingImage(index: number) {
  const image = existingImages.value[index]
  existingImages.value.splice(index, 1)
  existingImages.value.unshift(image) // ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾
}
```

### 2. ÐŸÑ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ÑÑ `display_order`
```typescript
// adminProductsStore.ts - _manageProductImages()
if (existingImages.length > 0) {
  for (let i = 0; i < existingImages.length; i++) {
    await supabase
      .from('product_images')
      .update({ display_order: i })
      .eq('id', existingImages[i].id)
  }
}
```

### 3. ÐšÐµÑˆ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÑ‚ÑÑ Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ
```typescript
await clearProductCache(productId) // Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
await refresh()                     // ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° useAsyncData
```

## Best Practices

### âœ… DO:
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ `clearProductCache(id)` Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ ÐºÐµÑˆÐ° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
- Ð’Ñ‹Ð·Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ `refresh()` Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð½Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ" ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹

### âŒ DON'T:
- ÐÐµ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ `hardReset()` Ð±ÐµÐ· Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ)
- ÐÐµ Ð·Ð°Ð±Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‡Ð¸Ñ‰Ð°Ñ‚ÑŒ Pinia store Ð¿Ñ€Ð¸ Ð¼ÑƒÑ‚Ð°Ñ†Ð¸ÑÑ… (`products = []`)
- ÐÐµ Ð¿Ð¾Ð»Ð°Ð³Ð°Ð¹Ñ‚ÐµÑÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð¸Ð½Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÑŽ Ð±ÐµÐ· `refresh()` Ð´Ð»Ñ useAsyncData

## Troubleshooting

### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ?
1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ console Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð‘Ð”
2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ" Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ
3. Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð»Ð¾ - "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐµÑˆ" Ð² header
4. Ð’ ÐºÑ€Ð°Ð¹Ð½ÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ðµ - "ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ ÑÐ±Ñ€Ð¾Ñ"

### Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ?
1. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² Ð‘Ð” (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ `display_order`)
2. ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚Ðµ ÐºÐµÑˆ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ (F5)

### ÐšÐµÑˆ Ð½Ðµ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÑ‚ÑÑ?
1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ localStorage (DevTools â†’ Application â†’ Local Storage)
2. ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚Ðµ `tanstack-query-cache` Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
3. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ "ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ ÑÐ±Ñ€Ð¾Ñ"
