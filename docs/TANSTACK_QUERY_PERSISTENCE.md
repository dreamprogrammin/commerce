# TanStack Query Persistence

## –û–±–∑–æ—Ä

TanStack Query –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å persistence –≤ localStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–µ—à–∞ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–æ persistence

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç ‚Üí –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Å API
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É ‚Üí –∫–µ—à —Ç–µ—Ä—è–µ—Ç—Å—è
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç —Å–Ω–æ–≤–∞ ‚Üí **–∑–∞–Ω–æ–≤–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ**

### –ü–æ—Å–ª–µ persistence

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç ‚Üí –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Å API ‚Üí **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage**
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É ‚Üí **–∫–µ—à —Å–æ—Ö—Ä–∞–Ω—ë–Ω**
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç —Å–Ω–æ–≤–∞ ‚Üí **–¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage, –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞!**

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –§–∞–π–ª: `/plugins/vue-query.ts`

```typescript
persistQueryClient({
  queryClient,
  persister,
  maxAge: 1000 * 60 * 60 * 24, // 24 —á–∞—Å–∞
  dehydrateOptions: {
    shouldDehydrateQuery: (query) => {
      return query.state.status === 'success' // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    },
  },
})
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:

- **maxAge**: `24 —á–∞—Å–∞` - –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ localStorage
- **throttleTime**: `1 —Å–µ–∫—É–Ω–¥–∞` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- **key**: `tanstack-query-cache` - –∫–ª—é—á –≤ localStorage
- **shouldDehydrateQuery**: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã **–ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
  - ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è: `home-*`, `catalog-*`, `category-*`, `global-*` (–ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
  - ‚ùå –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è: `user-*`, `profile-*` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

## –ß—Ç–æ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage:

- ‚úÖ –°–ª–∞–π–¥—ã –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (`global-slides`)
- ‚úÖ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (`home-popular-categories`)
- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (`home-recommendations`)
- ‚úÖ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (`home-popular`)
- ‚úÖ –ù–æ–≤—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (`home-newest`)
- ‚úÖ –ë–∞–Ω–Ω–µ—Ä—ã (`home-banners`)
- ‚úÖ –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (`catalog-products`)
- ‚úÖ –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ TanStack Query

### –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage:

- ‚ùå **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (`user-*`, `profile-*`):
  - –ó–∞–∫–∞–∑—ã (`user-orders`, `user-orders-recent`)
  - –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (`user-wishlist`, `user-wishlist-recent`)
  - –ë–æ–Ω—É—Å—ã (`user-bonus`, `user-bonus-recent`)
  - –ü—Ä–æ—Ñ–∏–ª—å (`profile-*`)
- ‚ùå –ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–æ—à–∏–±–∫–∏)
- ‚ùå –î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
- ‚ùå –î–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏

### –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (`home-*`, `catalog-*`, etc.):

1. **SSR state** (–µ—Å–ª–∏ –µ—Å—Ç—å) - –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
2. **localStorage cache** - —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∫–µ—à
3. **API request** - —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞

### –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (`user-*`, `profile-*`):

1. **SSR state** (–µ—Å–ª–∏ –µ—Å—Ç—å) - –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–æ `/profile/**` –æ—Ç–∫–ª—é—á–µ–Ω SSR)
2. **Pinia store cache** - –¥–∞–Ω–Ω—ã–µ –∏–∑ Pinia (—Å `pinia-plugin-persistedstate`)
3. **API request** - —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç TanStack Query localStorage persistence –∏–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –í DevTools:

1. –û—Ç–∫—Ä–æ–π `Application` ‚Üí `Local Storage` ‚Üí `https://uhti.kz`
2. –ù–∞–π–¥–∏ –∫–ª—é—á `tanstack-query-cache`
3. –£–≤–∏–¥–∏—à—å JSON —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### –¢–µ—Å—Ç:

1. –û—Ç–∫—Ä–æ–π –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è)
2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
3. –£–≤–∏–¥–∏—à—å **–º–≥–Ω–æ–≤–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É** –±–µ–∑ skeleton loaders!

## –†–∞–∑–º–µ—Ä –∫–µ—à–∞

–¢–∏–ø–∏—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä: **~500KB - 2MB** –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑–º–µ—Ä–∞:

- `staleTime: 5 –º–∏–Ω—É—Ç` - –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- `gcTime: 10 –º–∏–Ω—É—Ç` - —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏
- `maxAge: 24 —á–∞—Å–∞` - —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ localStorage

## –û—Ç–∫–ª—é—á–µ–Ω–∏–µ persistence

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ç–µ—Å—Ç–æ–≤):

```typescript
// –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –≤ plugins/vue-query.ts
// persistQueryClient({ ... })
```

–ò–ª–∏ —É–¥–∞–ª–∏ –∏–∑ localStorage –≤—Ä—É—á–Ω—É—é:

```javascript
localStorage.removeItem('tanstack-query-cache')
```

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (`staleTime`) - —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ü–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ) - –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

### –í—Ä—É—á–Ω—É—é:

```typescript
const queryClient = useQueryClient()
queryClient.invalidateQueries({ queryKey: ['home-popular'] })
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ü–ª—é—Å—ã:

- ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (0ms –≤–º–µ—Å—Ç–æ 100-500ms)
- üìâ –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Supabase API
- üí∞ –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ API requests (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è read-only –¥–∞–Ω–Ω—ã—Ö)
- üöÄ –õ—É—á—à–∏–π UX - –Ω–µ—Ç skeleton loaders –ø—Ä–∏ F5

### –ú–∏–Ω—É—Å—ã:

- üì¶ ~1-2MB –≤ localStorage (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ)
- üîÑ –†–∏—Å–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (—Ä–µ—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ staleTime)

## Best Practices

1. **–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã** - query —Å –∫–ª—é—á–∞–º–∏ `user-*` –∏ `profile-*` –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage (–∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–æ–ª—å–∫–æ Pinia persistence)
2. **–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π staleTime** - 5 –º–∏–Ω—É—Ç –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, 1-2 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö
3. **–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–π –ø–æ—Å–ª–µ –º—É—Ç–∞—Ü–∏–π** - –æ–±–Ω–æ–≤–ª—è–π –∫–µ—à –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å —Ä–∞–∑–º–µ—Ä localStorage** - –Ω–µ —Ö—Ä–∞–Ω–∏ –±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
5. **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ queryKeys**:
   - –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: `home-*`, `catalog-*`, `category-*`, `global-*`
   - –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: `user-*`, `profile-*` (–Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ localStorage)

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `/plugins/vue-query.ts` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ persistence
- `/composables/slides/useSlides.ts` - –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Query
- `/pages/index.vue` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Query –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- `package.json` - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:
  - `@tanstack/query-persist-client-core`
  - `@tanstack/query-sync-storage-persister`
