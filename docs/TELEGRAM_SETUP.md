# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram-–±–æ—Ç–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –û–±–∑–æ—Ä

–ë–æ—Ç `@babyShopOfficialStoreKz_bot` –≤—ã–ø–æ–ª–Ω—è–µ—Ç 3 —Ä–æ–ª–∏:

| –†–æ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ | –°–≤—è–∑—å Telegram —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –Ω–∞ —Å–∞–π—Ç–µ (–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è) |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤, –±–æ–Ω—É—Å—ã, –∞–∫—Ü–∏–∏ |
| –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∞ | –ú–∞—Å—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Edge Functions

| –§—É–Ω–∫—Ü–∏—è | JWT | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|-----|-----------|
| `telegram-webhook` | off | –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç—É |
| `send-user-telegram` | off | –õ–∏—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ë–î) |
| `send-broadcast` | off | –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∞ |
| `notify-order-to-telegram` | off | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ |

### –¢–∞–±–ª–∏—Ü—ã –ë–î

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|-----------|
| `profiles.telegram_chat_id` | Chat ID –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ Telegram |
| `telegram_link_codes` | –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–¥—ã –ø—Ä–∏–≤—è–∑–∫–∏ (—Å–∞–π—Ç ‚Üí –±–æ—Ç) |
| `telegram_reverse_links` | –û–±—Ä–∞—Ç–Ω—ã–µ –∫–æ–¥—ã –ø—Ä–∏–≤—è–∑–∫–∏ (–±–æ—Ç ‚Üí —Å–∞–π—Ç) |
| `telegram_broadcasts` | –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ |

### –ü–æ—Ç–æ–∫–∏ –ø—Ä–∏–≤—è–∑–∫–∏

**–í–∞—Ä–∏–∞–Ω—Ç 1: –°–∞–π—Ç ‚Üí Telegram (—á–µ—Ä–µ–∑ deep link)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–∞–π—Ç–µ ‚Üí "–ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram"
    ‚Üì
–°–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–¥ –≤ telegram_link_codes (10 –º–∏–Ω—É—Ç)
    ‚Üì
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è t.me/babyShopOfficialStoreKz_bot?start={–∫–æ–¥}
    ‚Üì
–ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç /start {–∫–æ–¥} ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–¥ ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç chat_id –∫ –ø—Ä–æ—Ñ–∏–ª—é
    ‚Üì
‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∞–Ω
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: Telegram ‚Üí –°–∞–π—Ç (one-click, –æ–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞)**

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç START –≤ –±–æ—Ç–µ
    ‚Üì
–ë–æ—Ç —Å–æ–∑–¥–∞—ë—Ç –∫–æ–¥ –≤ telegram_reverse_links (10 –º–∏–Ω—É—Ç)
    ‚Üì
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ‚Üí uhti.kz/telegram-link?code={–∫–æ–¥}
    ‚Üì
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–∑—ã–≤–∞–µ—Ç RPC link_telegram_by_code ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç chat_id
    ‚Üì
‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∞–Ω (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
```

### –ü–æ—Ç–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```
–°–æ–±—ã—Ç–∏–µ (—Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ / –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤)
    ‚Üì
–¢—Ä–∏–≥–≥–µ—Ä –ë–î ‚Üí INSERT –≤ notifications
    ‚Üì (3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞)
    ‚îú‚îÄ‚îÄ 1. Realtime ‚Üí in-app (–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫)
    ‚îú‚îÄ‚îÄ 2. trigger_push_on_notification ‚Üí Web Push
    ‚îî‚îÄ‚îÄ 3. trigger_telegram_on_notification ‚Üí send-user-telegram ‚Üí Telegram API
```

---

## –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –°–µ–∫—Ä–µ—Ç—ã Supabase

–í Supabase Dashboard ‚Üí Settings ‚Üí Edge Functions ‚Üí Secrets:

```
TELEGRAM_BOT_TOKEN=<—Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather>
TELEGRAM_CHAT_ID=<chat_id –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∑–∞–∫–∞–∑–∞—Ö>
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
supabase db push
```

–ö–ª—é—á–µ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
- `20260221000001_user_notifications_and_telegram.sql` ‚Äî telegram_link_codes, telegram_broadcasts, —Ç—Ä–∏–≥–≥–µ—Ä—ã
- `20260221120000_skip_telegram_for_offline_sales.sql` ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂–∏ –Ω–µ –ø–∞–¥–∞—é—Ç –≤ Telegram
- `20260222230000_telegram_reverse_link.sql` ‚Äî telegram_reverse_links, RPC link_telegram_by_code

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π Edge Functions

```bash
supabase functions deploy telegram-webhook --no-verify-jwt
supabase functions deploy send-user-telegram --no-verify-jwt
supabase functions deploy send-broadcast --no-verify-jwt
supabase functions deploy notify-order-to-telegram --no-verify-jwt
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ (–æ–¥–∏–Ω —Ä–∞–∑)

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É `/setup`. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç webhook URL
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ–º–∞–Ω–¥—ã –º–µ–Ω—é (/start, /unlink)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞ (–≤–∏–¥–Ω–æ –ø–µ—Ä–µ–¥ START)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–≤–∏–¥–Ω–æ –≤ –ø–æ–∏—Å–∫–µ)

–ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç –æ—Ç—á—ë—Ç–æ–º:

```
üîß Setup complete:

Webhook: ‚úÖ Webhook was set
Commands: ‚úÖ
Description: ‚úÖ
Short desc: ‚úÖ
```

> **–í–∞–∂–Ω–æ:** `/setup` –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –±–µ–∑–æ–ø–∞—Å–µ–Ω, –Ω–æ –Ω–µ –Ω—É–∂–µ–Ω.

### –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è

1. –ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Å—Ç–∏–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä "–º–∞—à–µ—Ç –ø—Ä–∏–≤–µ—Ç")
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å—Ç–∏–∫–µ—Ä –±–æ—Ç—É
3. –ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç file_id —Å—Ç–∏–∫–µ—Ä–∞
4. –í—Å—Ç–∞–≤—å—Ç–µ file_id –≤ `WELCOME_STICKER` –≤ `supabase/functions/telegram-webhook/index.ts`
5. –ü–µ—Ä–µ–¥–µ–ø–ª–æ–π—Ç–µ: `supabase functions deploy telegram-webhook --no-verify-jwt`

```typescript
// supabase/functions/telegram-webhook/index.ts
const WELCOME_STICKER = 'CAACAgIAAxkBAAE...'  // ‚Üê –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞
```

> –ï—Å–ª–∏ file_id –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —ç–º–æ–¥–∑–∏ üëã –≤–º–µ—Å—Ç–æ —Å—Ç–∏–∫–µ—Ä–∞ (fallback).

---

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|---------|-----------|
| `/start` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: —Å—Ç–∏–∫–µ—Ä + —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–ø—Ä–∏–≤—è–∑–∫–∞, –º–∞–≥–∞–∑–∏–Ω) |
| `/start {–∫–æ–¥}` | –ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ —á–µ—Ä–µ–∑ deep link —Å —Å–∞–π—Ç–∞ |
| `/unlink` | –û—Ç–≤—è–∑–∫–∞ Telegram –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `/setup` | –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ (webhook, –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–æ–º–∞–Ω–¥—ã) |
| –õ—é–±–æ–π —Å—Ç–∏–∫–µ—Ä | –ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç file_id —Å—Ç–∏–∫–µ—Ä–∞ (–¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ WELCOME_STICKER) |

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### Backend

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `supabase/functions/telegram-webhook/index.ts` | Webhook –±–æ—Ç–∞ (v5) |
| `supabase/functions/send-user-telegram/index.ts` | –õ–∏—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |
| `supabase/functions/send-broadcast/index.ts` | –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ |
| `supabase/functions/notify-order-to-telegram/index.ts` | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç |
| `supabase/config.toml` | –ö–æ–Ω—Ñ–∏–≥ —Ñ—É–Ω–∫—Ü–∏–π (verify_jwt = false) |

### Frontend

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `components/profile/TelegramBanner.vue` | –ë–∞–Ω–Ω–µ—Ä "–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ Telegram" (–ø—Ä–æ—Ñ–∏–ª—å, –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞) |
| `components/profile/TelegramLinkButton.vue` | –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏/–æ—Ç–≤—è–∑–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è |
| `pages/telegram-link.vue` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ (–±–æ—Ç ‚Üí —Å–∞–π—Ç) |
| `pages/admin/broadcast.vue` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ |
| `stores/adminStore/adminBroadcastStore.ts` | –°—Ç–æ—Ä –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ |

### –ú–∏–≥—Ä–∞—Ü–∏–∏

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `20260221000001_user_notifications_and_telegram.sql` | –û—Å–Ω–æ–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è: —Ç–∞–±–ª–∏—Ü—ã + —Ç—Ä–∏–≥–≥–µ—Ä—ã |
| `20260221120000_skip_telegram_for_offline_sales.sql` | –û—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂–∏ –Ω–µ —É–≤–µ–¥–æ–º–ª—è—é—Ç –≤ Telegram |
| `20260222230000_telegram_reverse_link.sql` | –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ (–±–æ—Ç ‚Üí —Å–∞–π—Ç) |

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ config.toml

–¢—Ä–∏ Telegram-—Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ `supabase/config.toml` —Å `verify_jwt = false`:

```toml
[functions.telegram-webhook]
enabled = true
verify_jwt = false
entrypoint = "./functions/telegram-webhook/index.ts"

[functions.send-user-telegram]
enabled = true
verify_jwt = false
entrypoint = "./functions/send-user-telegram/index.ts"

[functions.send-broadcast]
enabled = true
verify_jwt = false
entrypoint = "./functions/send-broadcast/index.ts"
```

> –ë–µ–∑ `verify_jwt = false` Telegram –Ω–µ —Å–º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã ‚Äî –ø–æ–ª—É—á–∏—Ç–µ 401.

---

## –û—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂–∏ –∏ Telegram

–û—Ñ—Ñ–ª–∞–π–Ω –ø—Ä–æ–¥–∞–∂–∏ (POS-–∫–∞—Å—Å–∞) **–Ω–µ** –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π Telegram-—á–∞—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–º —Å–æ–∑–¥–∞–ª —ç—Ç—É –ø—Ä–æ–¥–∞–∂—É.

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö:

```sql
-- –í notify_user_order_to_telegram() –∏ notify_guest_checkout_to_telegram()
IF NEW.source = 'offline' THEN
  RETURN NEW;
END IF;
```

---

## Troubleshooting

### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å webhook
curl "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"

# –õ–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏
supabase functions logs telegram-webhook
```

–ï—Å–ª–∏ webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ `/setup` –±–æ—Ç—É.

### /start –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —á–∞—Ç–∞

–ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `deleteMessage` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `/start`. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram:
- –í –ø—Ä–∏–≤–∞—Ç–Ω–æ–º —á–∞—Ç–µ –±–æ—Ç –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 48 —á–∞—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ `üóë deleteMessage: chat_id=... message_id=...`

### –°—Ç–∏–∫–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –ª—é–±–æ–π —Å—Ç–∏–∫–µ—Ä ‚Üí –ø–æ–ª—É—á–∏—Ç–µ file_id
2. –û–±–Ω–æ–≤–∏—Ç–µ `WELCOME_STICKER` –≤ –∫–æ–¥–µ
3. –ü–µ—Ä–µ–¥–µ–ø–ª–æ–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é

> file_id –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –±–æ—Ç—É. –°—Ç–∏–∫–µ—Ä –æ—Ç –¥—Ä—É–≥–æ–≥–æ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç.

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `profiles.telegram_chat_id` –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `supabase functions logs send-user-telegram`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ (–æ—à–∏–±–∫–∞ 403)

### –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `telegram_reverse_links` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ RPC `link_telegram_by_code` —Å–æ–∑–¥–∞–Ω–∞:
   ```sql
   SELECT routine_name FROM information_schema.routines
   WHERE routine_name = 'link_telegram_by_code';
   ```
3. –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç 10 –º–∏–Ω—É—Ç ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å
4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/telegram-link` —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø–æ–∫–∞–∂–µ—Ç –∫–Ω–æ–ø–∫—É "–í–æ–π—Ç–∏"

### –û—à–∏–±–∫–∞ 429 (Rate Limiting)

–í v5 —É–±—Ä–∞–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã Telegram API –∏–∑ —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ 429 ‚Äî –∑–Ω–∞—á–∏—Ç –∑–∞–ø—É—â–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è. –ü–µ—Ä–µ–¥–µ–ø–ª–æ–π—Ç–µ:

```bash
supabase functions deploy telegram-webhook --no-verify-jwt
```

### –¢—Ä–∏–≥–≥–µ—Ä—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç

```sql
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE trigger_name LIKE '%telegram%' OR trigger_name LIKE '%order_status%';
```

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (v5)

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —ç–º–æ–¥–∑–∏-–ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:

| –ü—Ä–µ—Ñ–∏–∫—Å | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| `üì©` | –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Telegram |
| `üí¨` | –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (chat_id, text) |
| `üîó` | –ù–∞—á–∞–ª–æ –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ –∫–æ–¥—É |
| `üëã` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–±–µ–∑ –∫–æ–¥–∞) |
| `üîì` | –û—Ç–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `üîß` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ (/setup) |
| `üé≠` | –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ |
| `üì§` | –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `üóë` | –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `üè†` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (sendWelcome) |
| `‚úÖ` | –£—Å–ø–µ—à–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è |
| `‚ùå` | –û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ |

–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:

```bash
supabase functions logs telegram-webhook --tail
```

---

## –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|--------|----------|
| v1 | –ë–∞–∑–æ–≤—ã–π webhook: /start + –ø—Ä–∏–≤—è–∑–∫–∞ —á–µ—Ä–µ–∑ deep link |
| v2 | –î–æ–±–∞–≤–ª–µ–Ω—ã /unlink, —Å—Ç–∏–∫–µ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, HTML-—Å–æ–æ–±—â–µ–Ω–∏—è |
| v3 | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ v3 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (orders + guest_checkouts) |
| v4 | –•–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç: setWebhook, setMyCommands, setMyDescription. –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ (–±–æ—Ç ‚Üí —Å–∞–π—Ç) |
| v5 | –£–±—Ä–∞–Ω —Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç (fix 429). –î–æ–±–∞–≤–ª–µ–Ω–∞ /setup. Plain text –≤–º–µ—Å—Ç–æ Markdown. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
